(function(){function e(){if(!window.PublicKeyCredential){alert("Error: this browser does not support WebAuthn");return false}return true}function n(){return typeof window.PublicKeyCredential!="undefined"}function o(n){try{n=String(n).replace(/_/g,"/").replace(/-/g,"+");return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}catch(e){console.error(e+": "+n)}}function u(e){return btoa(String.fromCharCode.apply(null,new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function t(e){var n=this;this.options={urlPrefix:"/webauthn",debug:false,getRegisterData:function(){return{}},getLoginData:function(){return{}},getUnbindData:function(){return{}},onRegisterSuccess:function(e){n.options.debug&&console.log(e)},onRegisterError:function(e){n.options.debug&&console.error(e)},onLoginSuccess:function(e){n.options.debug&&console.log(e)},onLoginError:function(e){n.options.debug&&console.error(e)},onUnbindSuccess:function(e){n.options.debug&&console.log(e)},onUnbindError:function(e){n.options.debug&&console.error(e)},checkResponseBeginLogin:function(e){return e},checkResponseFinishLogin:function(e){return e},checkResponseBeginRegister:function(e){return e},checkResponseFinishRegister:function(e){return e},checkResponseBeginUnbind:function(e){return e},checkResponseFinishUnbind:function(e){return e}};$.extend(this.options,e||{})}t.prototype.check=e;t.prototype.isSupported=n();t.prototype.register=function(i){if(i===""){alert("Please enter a username");return}var r=this;$.post(r.options.urlPrefix+"/register/begin/"+i,r.options.getRegisterData(),function(e){e=r.options.checkResponseBeginRegister(e);return e},"json").then(e=>{r.options.debug&&console.log(e);if(typeof e.Code!="undefined")throw new Error(e.Info);e.publicKey.challenge=o(e.publicKey.challenge);e.publicKey.user.id=o(e.publicKey.user.id);if(e.publicKey.excludeCredentials){for(var n=0;n<e.publicKey.excludeCredentials.length;n++){e.publicKey.excludeCredentials[n].id=o(e.publicKey.excludeCredentials[n].id)}}return navigator.credentials.create({publicKey:e.publicKey})}).then(e=>{r.options.debug&&console.log(e);let n=e.response.attestationObject;let o=e.response.clientDataJSON;let t=e.rawId;$.ajax({type:"post",url:r.options.urlPrefix+"/register/finish/"+i,dataType:"json",async:false,data:JSON.stringify({id:e.id,rawId:u(t),type:e.type,response:{attestationObject:u(n),clientDataJSON:u(o)}}),success:function(e){e=r.options.checkResponseFinishRegister(e);return e}})}).then(e=>{r.options.debug&&alert("successfully registered "+i+"!");r.options.onRegisterSuccess.call(this,e)}).catch(e=>{console.log("failed to register "+i+": "+e);r.options.onRegisterError.call(this,e)})};t.prototype.auth=function(s,c){if(s===""){alert("Please enter a username");return}var l=this;$.post(l.options.urlPrefix+"/"+c+"/begin/"+s,c=="login"?l.options.getLoginData():l.options.getUnbindData(),function(e){if(c=="login"){e=l.options.checkResponseBeginLogin(e)}else{e=l.options.checkResponseBeginUnbind(e)}return e},"json").then(e=>{l.options.debug&&console.log(e);if(typeof e.Code!="undefined")throw new Error(e.Info);e.publicKey.challenge=o(e.publicKey.challenge);e.publicKey.allowCredentials.forEach(function(e){e.id=o(e.id)});return navigator.credentials.get({publicKey:e.publicKey})}).then(e=>{l.options.debug&&console.log(e);let n=e.response.authenticatorData;let o=e.response.clientDataJSON;let t=e.rawId;let i=e.response.signature;let r=e.response.userHandle;$.ajax({type:"post",url:l.options.urlPrefix+"/"+c+"/finish/"+s,dataType:"json",async:false,data:JSON.stringify({id:e.id,rawId:u(t),type:e.type,response:{authenticatorData:u(n),clientDataJSON:u(o),signature:u(i),userHandle:u(r)}}),success:function(e){if(c=="login"){e=l.options.checkResponseFinishLogin(e)}else{e=l.options.checkResponseFinishUnbind(e)}return e}})}).then(e=>{l.options.debug&&alert("successfully "+c+" "+s+"!");if(c=="login"){l.options.onLoginSuccess.call(this,e)}else{l.options.onUnbindSuccess.call(this,e)}}).catch(e=>{console.log("failed to "+c+" "+s+": "+e);if(c=="login"){l.options.onLoginError.call(this,e)}else{l.options.onUnbindError.call(this,e)}})};t.prototype.login=function(e){this.auth(e,"login")};t.prototype.unbind=function(e){this.auth(e,"unbind")};window.WebAuthn=t})();